<html>
  <head>


        <link type="text/css" rel="stylesheet" href="css/graph.css">
        <link type="text/css" rel="stylesheet" href="css/detail.css">
    	<script src="js/d3.v3/d3.v3.js"></script>

    	<script src="js/jquery-2.0.0.min.js"></script>

    	<script src="js/rickshaw.js"></script>

        <style>
        #chart_container {
                position: fixed;
                font-family: Arial, Helvetica, sans-serif;
        }
        #chart {
                position: absolute;
                top: 0;
                left: 40px;
        }
        #y_axis {
                position: absolute;
                top: 0;
                bottom: 0;
                width: 40px;
        }
        #legend_container {
                position: absolute;
                right: 0;
                bottom: 26px;
                width: 0;
        }
        .detail_swatch { float: right; display: inline-block; width: 10px; height: 10px; margin: 0 4px 0 0 }

        #tracker {
            width: 150px;
            height: 300px;
            background-color: #D1E6F0;
            margin-right: 5em;
            padding-right: 1em;
            padding-top: 1em;
            padding-bottom: 1em;
            padding-left: 1em;

        }

        #trackerDistribution {
            padding-top: 1em;
            margin-left: auto;
            margin-right: auto;
        }

        #injections_chart {
            position: absolute;
            top: 0;
            left: 40px;
          }

        </style>
  </head>
  <body>
  <div id="chart_container">
    <div id="y_axis"></div>
  	<div id="chart" style="clear: both"></div>
  	<div id="injections_chart" style="clear: both"></div>
  	<div id="legend_container">
  		<div id="smoother" title="Smoothing"></div>
  		<div id="legend"></div>
  	</div>
  	<div id="slider"></div>
  </div>

  <div style="float: right;" id="tracker">
      Oh yesterday...
      <div id="trackerData"></div>
      <div id="trackerDistribution"></div>
  </div>


<script>
var graph = new Rickshaw.Graph.Ajax( {
	element: document.getElementById("chart"),
	width: 1200,
	height: 600,
	renderer: 'multi',
    max: 300,
    min: 0,
	dataURL: '{{.DataPath}}',
	series: [
        {
            name: 'You.Injection',
            color: '#4D94FF',
            width: 2,
            renderer: 'scatterplot'
        }, {
            name: 'You.Carbohydrates',
            color: '#E65C5C',
            width: 2,
            renderer: 'scatterplot'
        }, {
			name: 'You',
            color: 'steelblue',
            width: 2,
            renderer: 'line'
		},
         // Ugly workaround because scatterplot for injections and carbs are not placed correctly unless the reads line
         // has a scatterplot too..and we don't want to show it so we set the color to none
           {
            name: 'You',
            color: 'none',
            opacity: '0',
            width: 2,
            renderer: 'scatterplot'
        }, {
			name: 'Perfection',
		    color: '#33AD33',
		    width: 2,
            renderer: 'line'
		}
		 ],
	onComplete: function(transport) {
	    var x_axis = new Rickshaw.Graph.Axis.Time({
	          graph: transport.graph,
	        });
	    x_axis.graph.update();

	    var y_axis = new Rickshaw.Graph.Axis.Y( {
		            graph: transport.graph,
		            orientation: 'left',
		            tickFormat: Rickshaw.Fixtures.Number.formatKMBT,
		            element: document.getElementById('y_axis'),
		} );
        y_axis.graph.update();

        var hoverDetail = new Rickshaw.Graph.HoverDetail( {
                graph: transport.graph,
                formatter: function(series, x, y, formattedX, formattedY, d) {
                        var date = '<span class="date">' + new Date(x * 1000).toTimeString() + '</span>';
                        var swatch = '<span class="detail_swatch" style="background-color: ' + series.color + '"></span>';
                        var content = null;
                        if (series.name.indexOf('.') > 0) {
                            content = swatch + series.name.substring(series.name.indexOf('.')+1) + ": " + parseFloat(d.value.r) + '<br>' + date;
                        } else {
                            content = swatch + series.name + ": " + parseInt(y) + '<br>' + date;
                        }
                        return content;
                    },
                xFormatter: function(x) {
                    return new Date(x * 1000).toTimeString();
                },
            } );
	  }
} );

</script>

<script>
    var distribution = null;
    $.getJSON('{{.DataPath}}.tracking', function(data) {
      var items = [];

      $.each(data, function(key, val) {
        if (key != 'distribution') {
            items.push('<tr><td>' + key + ': ' + Math.round(val*100)/100 + '</td></tr>');
        } else {
            distribution = val
        }
      });

      $('<table/>', {
        'class': 'tracking_table',
        html: items.join('')
      }).appendTo('#trackerData');

    var distributionGraph = new Rickshaw.Graph( {
        element: document.getElementById("trackerDistribution"),
        width: 150,
        height: 160,
        renderer: 'multi',
        stroke: true,
        series: [{
            color: 'steelblue',
            data: distribution,
            renderer: 'area'
        }]
    });

    distributionGraph.render();
    });
</script>

  </body>
</html>